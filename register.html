<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل حساب (وضع الفحص)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background-color: #000; color: white; padding: 20px; font-family: sans-serif; }
        .debug-box {
            background: #222; border: 1px dashed yellow; color: #0f0; 
            padding: 10px; margin-bottom: 20px; font-family: monospace; 
            font-size: 12px; text-align: left; direction: ltr; min-height: 100px;
        }
        .login-box { border: 2px solid #ffd700; padding: 20px; border-radius: 10px; }
        input { background: #333; color: white; border: 1px solid #555; width: 100%; padding: 10px; margin-bottom: 10px; }
        button { background: #ffd700; color: black; width: 100%; padding: 12px; font-weight: bold; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <h5 style="color: yellow;">شاشة المبرمج (Logs):</h5>
    <div id="logs" class="debug-box">Waiting for logs...<br></div>

    <div class="login-box">
        <h3>إنشاء حساب جديد</h3>
        <input type="email" id="email" placeholder="email@example.com">
        <input type="password" id="password" placeholder="Password">
        <button id="btn">تسجيل الحساب</button>
        <div style="margin-top: 15px;">
            <a href="index.html" style="color: #ffd700;">رجوع لتسجيل الدخول</a>
        </div>
    </div>

    <script>
        // دالة الكتابة في الشاشة السوداء
        function log(msg) {
            const box = document.getElementById('logs');
            box.innerHTML += `> ${msg}<br>`;
            console.log(msg);
        }

        log("Step 1: Script started execution.");

        // إعداد Supabase
        const SUPABASE_URL = 'https://oezehdkfucwhttsrocsv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lemVoZGtmdWN3aHR0c3JvY3N2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5Mzg4OTMsImV4cCI6MjA4MjUxNDg5M30.WB567kJLDTTWJMpkw8QLq3Y1DL0serVz6-v95TJubKo';
        
        let supabase = null;

        try {
            if (window.supabase) {
                log("Step 2: Supabase library found.");
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log("Step 3: Client initialized.");
            } else {
                log("ERROR: Supabase library NOT found (Check internet).");
            }
        } catch (e) {
            log("CRASH during init: " + e.message);
        }

        // ربط الزر (الطريقة الآمنة)
        const btn = document.getElementById('btn');
        btn.addEventListener('click', async function() {
            log("Button CLICKED!"); // إذا ظهرت هذه، فالزر يعمل
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                log("Warning: Empty fields.");
                alert("اكتب البيانات!");
                return;
            }

            if (!supabase) {
                log("Error: Supabase is not ready.");
                alert("النظام غير جاهز، حدث الصفحة.");
                return;
            }

            log(`Attempting signup for: ${email}`);
            btn.innerText = "جاري الاتصال...";

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) {
                    log("Signup ERROR: " + error.message);
                    alert("خطأ: " + error.message);
                    btn.innerText = "حاول مجدداً";
                } else {
                    log("Signup SUCCESS! User ID: " + (data.user?.id || 'unknown'));
                    
                    // محاولة إنشاء البروفايل
                    if (data.user) {
                        const { error: dbError } = await supabase.from('profiles').insert([
                            { id: data.user.id, username: email.split('@')[0] }
                        ]);
                        if (dbError) log("DB Insert Error: " + dbError.message);
                        else log("Profile created.");
                    }

                    alert("تم التسجيل! مبروك.");
                    window.location.href = "index.html";
                }
            } catch (err) {
                log("Catch Error: " + err.message);
            }
        });

        log("Step 4: Event listener attached. Ready.");
    </script>
</body>
</html>
